name: Backend Supply Chain

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Dependency Review
        uses: actions/dependency-review-action@v4

  composer-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer:v2

      - name: Composer audit (locked)
        run: composer audit --locked --no-interaction

  attest-source:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Build source bundle
        run: |
          tar -czf backend-source.tgz \
            app bootstrap config database routes \
            artisan composer.json composer.lock

      - name: Attest backend source bundle
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: backend-source.tgz
